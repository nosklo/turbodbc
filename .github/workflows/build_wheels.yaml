name: Build Wheels

on: [push, workflow_dispatch]

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # We only really care about Windows, but you can keep ubuntu-latest if you want linux wheels too
        os: [windows-2019]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true  # Ensure subprojects are downloaded
      # 1. Turbodbc requires Boost. We install it via Chocolatey on the Windows runner.
      # This saves us from having to compile Boost from scratch (which takes forever).
      - name: Install Boost (Windows)
        if: runner.os == 'Windows'
        run: |
          # CHANGED: 1.78.0 -> 1.74.0
          choco install boost-msvc-14.2 --version=1.74.0 -y --allow-empty-checksums
          
          # CHANGED: Update path to match 1_74_0
          echo "BOOST_ROOT=C:\local\boost_1_74_0" >> $env:GITHUB_ENV
          choco install pkgconfiglite -y
      - name: Build and Install simdutf (CMake)
        shell: cmd
        run: |
          git clone --depth 1 https://github.com/simdutf/simdutf.git
          
          :: Configure (Disable tests to save time)
          cmake -S simdutf -B build_simdutf -DCMAKE_INSTALL_PREFIX=C:\local\simdutf -DSIMDUTF_BENCHMARKS=OFF -DSIMDUTF_TESTS=OFF -DBUILD_SHARED_LIBS=OFF
          
          :: Build and Install
          cmake --build build_simdutf --target install --config Release
      - name: Create Arrow Config Script
        shell: python
        run: |
          code = r"""
          import pyarrow, os, sys
          # Output to a standard temp location
          pc_dir = r"C:\local\pkgconfig"
          os.makedirs(pc_dir, exist_ok=True)
          
          lib_dir = pyarrow.get_library_dirs()[0].replace("\\", "/")
          include_dir = pyarrow.get_include().replace("\\", "/")
          version = pyarrow.__version__
          
          content = f'''
          prefix={lib_dir}
          includedir={include_dir}
          libdir={lib_dir}
          Name: arrow
          Description: Apache Arrow
          Version: {version}
          Libs: -L${{libdir}} -larrow -larrow_python
          Cflags: -I${{includedir}}
          '''
          
          with open(os.path.join(pc_dir, "arrow.pc"), "w") as f:
              f.write(content)
          """
          with open("setup_arrow_env.py", "w") as f:
              f.write(code)

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.22.0
        env:
          # This command runs inside EACH python build environment.
          # It installs the CORRECT pyarrow for that version, then generates the matching .pc file.
          CIBW_BEFORE_BUILD: "pip install numpy pyarrow && python setup_arrow_env.py"
          
          # We just point to the folder where the script writes the .pc file
          CIBW_ENVIRONMENT_WINDOWS: >
            PKG_CONFIG_PATH='C:\local\pkgconfig;%PKG_CONFIG_PATH%'
            CMAKE_PREFIX_PATH='C:\local\simdutf;%CMAKE_PREFIX_PATH%'
            INCLUDE='C:\local\boost_1_74_0;%INCLUDE%'
            LIB='C:\local\boost_1_74_0\lib64-msvc-14.2;%LIB%'
            BOOST_ROOT='C:\local\boost_1_74_0'
            
          CIBW_ARCHS: "auto64"
         
          # Optional: Limit to specific python versions if you want to save time (e.g., cp310, cp311)
          CIBW_BUILD: "cp313-*"

      - uses: actions/upload-artifact@v4
        with:
          name: turbodbc-wheels
          path: ./wheelhouse/*.whl
